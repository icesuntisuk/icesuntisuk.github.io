<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Monopoly - The Incident Response Challenge</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans Thai', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; padding: 20px; gap: 20px; }
        .game-wrapper { background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2); padding: clamp(15px, 2vw, 30px); width: 100%; max-width: 950px; }
        .game-title { text-align: center; color: #2c3e50; font-size: clamp(1.5rem, 3vw, 2.2rem); font-weight: bold; margin-bottom: clamp(15px, 2vw, 20px); background: linear-gradient(45deg, #3498db, #e74c3c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .board-container { position: relative; width: 100%; max-width: 900px; margin: 0 auto; aspect-ratio: 1; background: #f8f9fa; border: clamp(4px, 1vw, 8px) solid #2c3e50; border-radius: 15px; }
        .board { position: relative; width: 100%; height: 100%; display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); }
        .center-area { grid-column: 2 / 11; grid-row: 2 / 11; background: linear-gradient(135deg, #74b9ff, #0984e3); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .center-title { font-size: clamp(1.2rem, 3vw, 2.5rem); font-weight: bold; color: white; text-align: center; }
        .space { border: 1px solid #34495e; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-size: clamp(0.5rem, 1vw, 0.75rem); font-weight: bold; position: relative; padding: 2px; overflow: hidden; }
        .space-name { font-size: clamp(0.45rem, 0.8vw, 0.7rem); line-height: 1.1; font-weight: bold; }
        .space-type { font-size: clamp(0.4rem, 0.7vw, 0.6rem); font-style: italic; opacity: 0.9; }
        .space-cost { font-size: clamp(0.4rem, 0.7vw, 0.6rem); margin-top: 2px; }
        .investment { background: #a9cce3; }
        .event { background: #f5b7b1; }
        .knowledge { background: #fdebd0; }
        .corner-go { background: #a3e4d7; }
        .corner-alert { background: #f5b041; }
        .corner-safe { background: #d2b4de; }
        .corner-quarantine { background: #abb2b9; }
        .ui-container { width: 100%; max-width: 450px; display: flex; flex-direction: column; gap: 15px; }
        .players-panel, .controls-panel, .log-panel { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 20px; }
        .panel-title { font-size: 1.4rem; font-weight: 700; color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .player-info { padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid transparent; transition: all 0.3s ease; }
        .player-info.active { background-color: #e9f5ff; transform: scale(1.02); }
        .player-name { font-weight: bold; font-size: 1.1rem; }
        .player-stats { font-size: 0.9rem; color: #34495e; display: flex; flex-wrap: wrap; gap: 5px 15px; }
        .player-score { font-size: 1rem; font-weight: bold; color: #27ae60; }
        .btn { padding: 10px 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; background: #3498db; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        .dice-area { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
        #dice-input { width: 80px; padding: 10px; border-radius: 8px; border: 2px solid #bdc3c7; font-size: 1rem; text-align: center; }
        #dice-result { font-size: 1.5rem; font-weight: bold; color: #e74c3c; margin-left: auto; }
        #log-box { height: 150px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px; overflow-y: auto; font-size: 0.85rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; text-align: center; }
        .card-back { border-radius: 15px; padding: 20px; color: white; }
        .green-card .card-back { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .red-card .card-back { background: linear-gradient(135deg, #ff5858, #f09819); }
        .quiz-card .card-back { background: linear-gradient(135deg, #667eea, #764ba2); }
        .card-title { font-size: 1.2rem; margin-bottom: 12px; font-weight: 700; }
        .card-description { font-size: 0.9rem; line-height: 1.4; margin-bottom: 15px; }
        .card-result { font-size: 1rem; font-weight: 700; background: rgba(255,255,255,0.2); padding: 10px; border-radius: 15px; margin-top: 10px; }
        .card-choices .choice { margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); text-align: left; cursor: pointer; }
        .card-choices .choice:hover { background: rgba(255,255,255,0.3); }
        .shield-btn { margin-top: 10px; background: #8e44ad; }

        /* --- Gemini Additions --- */
        /* Dice Animation */
        @keyframes dice-flash {
            0% { transform: scale(1); color: #e74c3c; }
            50% { transform: scale(1.5); color: #ff9800; }
            100% { transform: scale(1); color: #e74c3c; }
        }
        .dice-flash {
            animation: dice-flash 0.4s ease-in-out;
        }

        /* Player Tokens */
        .player-piece {
            position: absolute;
            width: 24px;
            height: 24px;
            transition: all 0.5s ease-in-out;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player-piece svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.7));
        }

        /* Ownership Marker */
        .owner-marker {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid white;
            box-shadow: 0 0 3px black;
        }

        .action-summary-content {
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
            text-align: center;
            border: 2px solid #3498db;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            animation: fadeInOut 3s ease-in-out forwards;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        .action-summary-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #3498db;
        }

        .action-summary-message {
            font-size: 1.1rem;
        }
    </style>
</head>
<body>

    <div id="setup-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏°</h2>
            <label for="player-count">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô:</label>
            <select id="player-count"><option value="2">2 ‡∏Ñ‡∏ô</option><option value="3">3 ‡∏Ñ‡∏ô</option><option value="4">4 ‡∏Ñ‡∏ô</option></select>
            <br><br><button id="start-game-btn" class="btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
        </div>
    </div>

    <div id="purchase-modal" class="modal-overlay"></div>
    <div id="card-modal" class="modal-overlay"></div>
    <div id="event-roll-modal" class="modal-overlay"></div>
    <div id="alert-modal" class_="modal-overlay"></div>
    <div id="action-summary-modal" class="modal-overlay" style="pointer-events: none;"></div>

    <div class="game-wrapper">
        <h1 class="game-title">üõ°Ô∏è Cyber Monopoly üõ°Ô∏è</h1>
        <div class="board-container">
            <div id="board" class="board">
                <div class="center-area"><div class="center-title">CYBER<br>SECURITY</div></div>
                <div class="space corner-go" data-id="1" style="grid-area: 11 / 11 / 12 / 12;"></div>
                <div class="space investment" data-id="2" style="grid-area: 11 / 10 / 12 / 11;"></div>
                <div class="space event" data-id="3" style="grid-area: 11 / 9 / 12 / 10;"></div>
                <div class="space knowledge" data-id="4" style="grid-area: 11 / 8 / 12 / 9;"></div>
                <div class="space investment" data-id="5" style="grid-area: 11 / 7 / 12 / 8;"></div>
                <div class="space investment" data-id="6" style="grid-area: 11 / 6 / 12 / 7;"></div>
                <div class="space event" data-id="7" style="grid-area: 11 / 5 / 12 / 6;"></div>
                <div class="space knowledge" data-id="8" style="grid-area: 11 / 4 / 12 / 5;"></div>
                <div class="space investment" data-id="9" style="grid-area: 11 / 3 / 12 / 4;"></div>
                <div class="space corner-alert" data-id="10" style="grid-area: 11 / 2 / 12 / 3;"></div>
                <div class="space corner-safe" data-id="20" style="grid-area: 1 / 1 / 2 / 2;"></div>
                <div class="space investment" data-id="19" style="grid-area: 2 / 1 / 3 / 2;"></div>
                <div class="space event" data-id="18" style="grid-area: 3 / 1 / 4 / 2;"></div>
                <div class="space knowledge" data-id="17" style="grid-area: 4 / 1 / 5 / 2;"></div>
                <div class="space investment" data-id="16" style="grid-area: 5 / 1 / 6 / 2;"></div>
                <div class="space event" data-id="15" style="grid-area: 6 / 1 / 7 / 2;"></div>
                <div class="space investment" data-id="14" style="grid-area: 7 / 1 / 8 / 2;"></div>
                <div class="space knowledge" data-id="13" style="grid-area: 8 / 1 / 9 / 2;"></div>
                <div class="space event" data-id="12" style="grid-area: 9 / 1 / 10 / 2;"></div>
                <div class="space investment" data-id="11" style="grid-area: 10 / 1 / 11 / 2;"></div>
                <div class="space corner-quarantine" data-id="30" style="grid-area: 1 / 11 / 2 / 12;"></div>
                <div class="space investment" data-id="29" style="grid-area: 1 / 10 / 2 / 11;"></div>
                <div class="space event" data-id="28" style="grid-area: 1 / 9 / 2 / 10;"></div>
                <div class="space knowledge" data-id="27" style="grid-area: 1 / 8 / 2 / 9;"></div>
                <div class="space investment" data-id="26" style="grid-area: 1 / 7 / 2 / 8;"></div>
                <div class="space event" data-id="25" style="grid-area: 1 / 6 / 2 / 7;"></div>
                <div class="space investment" data-id="24" style="grid-area: 1 / 5 / 2 / 6;"></div>
                <div class="space knowledge" data-id="23" style="grid-area: 1 / 4 / 2 / 5;"></div>
                <div class="space event" data-id="22" style="grid-area: 1 / 3 / 2 / 4;"></div>
                <div class="space investment" data-id="21" style="grid-area: 1 / 2 / 2 / 3;"></div>
                <div class="space corner-quarantine" data-id="40" style="grid-area: 11 / 1 / 12 / 2;"></div>
                <div class="space investment" data-id="39" style="grid-area: 10 / 11 / 11 / 12;"></div>
                <div class="space event" data-id="38" style="grid-area: 9 / 11 / 10 / 12;"></div>
                <div class="space knowledge" data-id="37" style="grid-area: 8 / 11 / 9 / 12;"></div>
                <div class="space investment" data-id="36" style="grid-area: 7 / 11 / 8 / 12;"></div>
                <div class="space event" data-id="35" style="grid-area: 6 / 11 / 7 / 12;"></div>
                <div class="space investment" data-id="34" style="grid-area: 5 / 11 / 6 / 12;"></div>
                <div class="space knowledge" data-id="33" style="grid-area: 4 / 11 / 5 / 12;"></div>
                <div class="space event" data-id="32" style="grid-area: 3 / 11 / 4 / 12;"></div>
                <div class="space investment" data-id="31" style="grid-area: 2 / 11 / 3 / 12;"></div>
            </div>
        </div>
    </div>

    <div class="ui-container">
        <div class="players-panel">
            <h3 class="panel-title">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h3>
            <div id="players-info-container"></div>
        </div>
        <div class="controls-panel">
            <h3 class="panel-title">‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á: <span id="current-player-name"></span></h3>
            <div id="round-counter" style="text-align: center; margin-bottom: 10px; font-weight: bold;"></div>
            <div class="dice-area">
                <button id="roll-dice-btn" class="btn">‡∏ó‡∏≠‡∏¢‡πÄ‡∏ï‡πã‡∏≤</button>
                <input type="number" id="dice-input" min="2" max="12" placeholder="‡πÄ‡∏•‡∏Ç">
                <button id="manual-roll-btn" class="btn">‡πÄ‡∏î‡∏¥‡∏ô</button>
                <div id="dice-result"></div>
            </div>
             <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button id="end-turn-btn" class="btn" disabled style="flex-grow: 1;">‡∏à‡∏ö‡∏ï‡∏≤</button>
                <button id="save-game-btn" class="btn" style="background: #27ae60;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button id="reset-game-btn" class="btn" style="background: #c0392b;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>
        <div class="log-panel">
            <h3 class="panel-title">‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</h3>
            <div id="log-box"></div>
        </div>
    </div>

<script>
const spaceData = [
    { id: 1, name: "Resource Allocation", type: "corner-go", costText: "‡∏ú‡πà‡∏≤‡∏ô: +$15K, +1üõ°Ô∏è" },
    { id: 2, name: "Firewall Upgrade", type: "investment", cost: 6000, reward: 1, rent: 1000, costText: "$6K ‚Üí +1üõ°Ô∏è", owner: null },
    { id: 3, name: "Draw Event Card", type: "event", costText: "‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î" },
    { id: 4, name: "Cyber Quiz", type: "knowledge", reward: { shields: 1 }, costText: "‡∏ñ‡∏π‡∏Å: +1üõ°Ô∏è" },
    { id: 5, name: "Antivirus Subscription", type: "investment", cost: 8000, reward: 1, rent: 1200, costText: "$8K ‚Üí +1üõ°Ô∏è", owner: null },
    { id: 6, name: "Patch Management", type: "investment", cost: 10000, reward: 2, rent: 1500, costText: "$10K ‚Üí +2üõ°Ô∏è", owner: null },
    { id: 7, name: "Draw Event Card", type: "event", costText: "‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î" },
    { id: 8, name: "Cyber Quiz", type: "knowledge", reward: { money: 2500 }, costText: "‡∏ñ‡∏π‡∏Å: +$2.5K" },
    { id: 9, name: "Secure Password Policy", type: "investment", cost: 5000, reward: 1, rent: 800, costText: "$5K ‚Üí +1üõ°Ô∏è", owner: null },
    { id: 10, name: "System Alert", type: "corner-alert", costText: "‡∏à‡πà‡∏≤‡∏¢ $5K ‡∏´‡∏£‡∏∑‡∏≠ -5 Ops" },
    { id: 11, name: "Phishing Simulation", type: "investment", cost: 12000, reward: 2, rent: 1800, costText: "$12K ‚Üí +2üõ°Ô∏è", owner: null },
    { id: 12, name: "Draw Event Card", type: "event", costText: "‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î" },
    { id: 13, name: "Cyber Quiz", type: "knowledge", reward: { shields: 1 }, costText: "‡∏ñ‡∏π‡∏Å: +1üõ°Ô∏è" },
    { id: 14, name: "Insider Threat Training", type: "investment", cost: 12000, reward: 2, rent: 1800, costText: "$12K ‚Üí +2üõ°Ô∏è", owner: null },
    { id: 15, name: "Draw Event Card", type: "event", costText: "‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î" },
    { id: 16, name: "IT Support Team", type: "investment", cost: 18000, reward: 3, rent: 2500, costText: "$18K ‚Üí +3üõ°Ô∏è", owner: null },
    { id: 17, name: "Cyber Quiz", type: "knowledge", reward: { money: 2500 }, costText: "‡∏ñ‡∏π‡∏Å: +$2.5K" },
    { id: 18, name: "Draw Event Card", type: "event", costText: "‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î" },
    { id: 19, name: "Clean Desk Policy", type: "investment", cost: 5000, reward: 1, rent: 800, costText: "$5K ‚Üí +1üõ°Ô∏è", owner: null },
    { id: 20, name: "Safe Zone", type: "corner-safe", costText: "‡∏û‡∏±‡∏Å‡∏ü‡∏£‡∏µ" },
    { id: 21, name: "EDR Solution", type: "investment", cost: 22000, reward: 4, rent: 3000, costText: "$22K ‚Üí +4üõ°Ô∏è", owner: null },
    { id: 22, name: "Draw Event Card", type: "event", costText: "‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î" },
    { id: 23, name: "Cyber Quiz", type: "knowledge", reward: { shields: 2 }, costText: "‡∏ñ‡∏π‡∏Å: +2üõ°Ô∏è" },
    { id: 24, name: "Data Backup System", type: "investment", cost: 20000, reward: 3, rent: 2800, costText: "$20K ‚Üí +3üõ°Ô∏è", owner: null },
    { id: 25, name: "Draw Event Card", type: "event", costText: "‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î" },
    { id: 26, name: "SIEM Monitoring", type: "investment", cost: 28000, reward: 5, rent: 4000, costText: "$28K ‚Üí +5üõ°Ô∏è", owner: null },
    { id: 27, name: "Cyber Quiz", type: "knowledge", reward: { money: 5000 }, costText: "‡∏ñ‡∏π‡∏Å: +$5K" },
    { id: 28, name: "Draw Event Card", type: "event", costText: "‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î" },
    { id: 29, name: "Network Segmentation", type: "investment", cost: 16000, reward: 3, rent: 2200, costText: "$16K ‚Üí +3üõ°Ô∏è", owner: null },
    { id: 30, name: "Go to Quarantine", type: "corner-quarantine", costText: "‡πÑ‡∏õ‡∏ä‡πà‡∏≠‡∏á 40" },
    { id: 31, name: "Incident Response Plan", type: "investment", cost: 15000, reward: 3, rent: 2000, costText: "$15K ‚Üí +3üõ°Ô∏è", owner: null },
    { id: 32, name: "Draw Event Card", type: "event", costText: "‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î" },
    { id: 33, name: "Cyber Quiz", type: "knowledge", reward: { shields: 2 }, costText: "‡∏ñ‡∏π‡∏Å: +2üõ°Ô∏è" },
    { id: 34, name: "Legal Counsel Retainer", type: "investment", cost: 10000, reward: 2, rent: 1500, costText: "$10K ‚Üí +2üõ°Ô∏è", owner: null },
    { id: 35, name: "Draw Event Card", type: "event", costText: "‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î" },
    { id: 36, name: "Cyber Insurance", type: "investment", cost: 25000, reward: 4, rent: 3500, costText: "$25K ‚Üí +4üõ°Ô∏è", owner: null },
    { id: 37, name: "Cyber Quiz", type: "knowledge", reward: { money: 5000 }, costText: "‡∏ñ‡∏π‡∏Å: +$5K" },
    { id: 38, name: "Draw Event Card", type: "event", costText: "‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î" },
    { id: 39, name: "PR Agency Contract", type: "investment", cost: 10000, reward: 2, rent: 1500, costText: "$10K ‚Üí +2üõ°Ô∏è", owner: null },
    { id: 40, name: "Quarantine", type: "corner-quarantine", costText: "‡∏´‡∏¢‡∏∏‡∏î 1 ‡∏ï‡∏≤" }
];
const greenCards = [
    { id: "G01", title: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏î‡∏µ‡πÄ‡∏î‡πà‡∏ô", description: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏• Phishing", effect: { reputation: 10, shields: 1 } },
    { id: "G02", title: "‡∏ú‡πà‡∏≤‡∏ô Audit ‡∏â‡∏•‡∏∏‡∏¢", description: "‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á", effect: { reputation: 10 } },
    { id: "G03", title: "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô", description: "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢", effect: { money: 10000 } },
    { id: "G04", title: "‡∏Ç‡πà‡∏≤‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏†‡∏±‡∏¢‡∏Ñ‡∏∏‡∏Å‡∏Ñ‡∏≤‡∏°", description: "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏Æ‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå", effect: { shields: 2 } },
    { id: "G05", title: "‡∏™‡∏∑‡πà‡∏≠‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°", description: "‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏ß‡∏•‡∏ä‡∏ô‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢", effect: { reputation: 15 } },
    { id: "G06", title: "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Patch ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥", description: "‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Patch ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á", effect: { shields: 2 } },
    { id: "G07", title: "‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏à‡∏≤‡∏Å CEO", description: "‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏û‡∏≠‡πÉ‡∏à‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢", effect: { money: 10000 } },
    { id: "G08", title: "‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏ñ‡∏π‡∏Å‡πÇ‡∏à‡∏°‡∏ï‡∏µ", description: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏±‡∏ô‡∏°‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô", effect: { reputation: 5 } },
    { id: "G09", title: "‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡πÉ‡∏´‡∏°‡πà", description: "‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≥", choices: [{ text: "‡∏à‡πà‡∏≤‡∏¢ $5K ‡∏£‡∏±‡∏ö +2üõ°Ô∏è", effect: { money: -5000, shields: 2 } }, { text: "‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£", effect: {} }] },
    { id: "G10", title: "‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≠‡∏°‡πÅ‡∏ú‡∏ô‡πÑ‡∏î‡πâ‡∏ú‡∏•", description: "‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≠‡∏°‡πÅ‡∏ú‡∏ô‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠ (Fire Drill) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", effect: { shields: 2 } },
    { id: "G11", title: "‡∏û‡∏±‡∏ô‡∏ò‡∏°‡∏¥‡∏ï‡∏£‡∏ó‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", description: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏±‡∏¢‡∏Ñ‡∏∏‡∏Å‡∏Ñ‡∏≤‡∏°", effect: { shields: 1 } },
    { id: "G12", title: "‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏•‡∏î‡∏•‡∏á", description: "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏î‡∏µ", effect: { money: 7500 } },
    { id: "G13", title: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏¢", description: "‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ü‡∏£‡∏µ", effect: { shields: 2 } },
    { id: "G14", title: "‡∏ã‡∏≠‡∏ü‡∏ï‡πå‡πÅ‡∏ß‡∏£‡πå Open Source", description: "‡πÄ‡∏à‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ Open Source ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏á‡∏ö", effect: { money: 5000 } },
    { id: "G15", title: "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤‡∏ß", description: "‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏ó‡∏≤‡∏á‡πÑ‡∏ã‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏•‡∏î‡∏•‡∏á", effect: {} }
];
const redCards = [
    { id: "R01", title: "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏õ‡∏•‡∏≠‡∏°", description: "CEO (‡∏õ‡∏•‡∏≠‡∏°) ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πà‡∏ß‡∏ô", choices: [{ text: "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡πÄ‡∏™‡∏µ‡∏¢ 5 Ops)", effect: { operations: -5 } }, { text: "‡∏û‡∏•‡∏≤‡∏î‡πÇ‡∏≠‡∏ô (‡πÄ‡∏™‡∏µ‡∏¢ $20K)", effect: { money: -20000 } }] },
    { id: "R02", title: "Wi-Fi ‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢", description: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wi-Fi ‡∏ü‡∏£‡∏µ", choices: [{ text: "‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™ (‡πÄ‡∏™‡∏µ‡∏¢ 5 Ops)", effect: { operations: -5 } }, { text: "‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏î‡∏ß‡∏á (‡πÄ‡∏™‡∏µ‡∏¢ 10 Rep)", effect: { reputation: -10 } }] },
    { id: "R03", title: "USB ‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤", description: "‡∏û‡∏ö USB ‡∏ï‡∏Å‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø", choices: [{ text: "‡∏ï‡∏¥‡∏î‡∏°‡∏±‡∏•‡πÅ‡∏ß‡∏£‡πå (‡πÄ‡∏™‡∏µ‡∏¢ 10 Ops)", effect: { operations: -10 } }, { text: "‡πÉ‡∏ä‡πâ 2üõ°Ô∏è ‡∏ö‡∏•‡πá‡∏≠‡∏Å", effect: { shields: -2 } }] },
    { id: "R04", title: "‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏•‡πà‡∏°", description: "‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å‡∏•‡πà‡∏°‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏", choices: [{ text: "‡∏ó‡∏∏‡πà‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡πÅ‡∏Å‡πâ‡∏î‡πà‡∏ß‡∏ô (‡πÄ‡∏™‡∏µ‡∏¢ $10K)", effect: { money: -10000 } }, { text: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏™‡∏µ‡∏¢ 10 Rep)", effect: { reputation: -10 } }] },
    { id: "R05", title: "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏≤‡∏î‡πÄ‡∏î‡∏≤‡∏á‡πà‡∏≤‡∏¢", description: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ä‡πâ 'password1234'", choices: [{ text: "‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏ö‡∏£‡∏° (‡πÄ‡∏™‡∏µ‡∏¢ $7.5K)", effect: { money: -7500 } }, { text: "‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ (‡πÄ‡∏™‡∏µ‡∏¢ 1üõ°Ô∏è, 5 Rep)", effect: { shields: -1, reputation: -5 } }] },
    { id: "R06", title: "DDoS Attack ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏≤", description: "‡πÄ‡∏ß‡πá‡∏ö‡∏ä‡πâ‡∏≤‡∏•‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏°‡∏ï‡∏µ", choices: [{ text: "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô (‡πÄ‡∏™‡∏µ‡∏¢ $12K)", effect: { money: -12000 } }, { text: "‡∏£‡∏≠‡∏à‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏≠‡∏á (‡πÄ‡∏™‡∏µ‡∏¢ 10 Rep)", effect: { reputation: -10 } }] },
    { id: "R07", title: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß", description: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏†‡∏≤‡∏û‡∏ö‡∏±‡∏ï‡∏£‡∏•‡∏á‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•", choices: [{ text: "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (‡πÄ‡∏™‡∏µ‡∏¢ 5 Ops, 5 Rep)", effect: { operations: -5, reputation: -5 } }, { text: "‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏Å‡∏±‡∏ö‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ (‡πÄ‡∏™‡∏µ‡∏¢ $5K, 5 Rep)", effect: { money: -5000, reputation: -5 } }] },
    { id: "R08", title: "Phishing ‡∏£‡∏∞‡∏ö‡∏≤‡∏î", description: "‡∏≠‡∏µ‡πÄ‡∏°‡∏• Phishing ‡∏´‡∏•‡∏∏‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö", choices: [{ text: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏î‡πâ (‡πÄ‡∏™‡∏µ‡∏¢ 1üõ°Ô∏è)", effect: { shields: -1 } }, { text: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å (‡πÄ‡∏™‡∏µ‡∏¢ 2üõ°Ô∏è, 5 Rep)", effect: { shields: -2, reputation: -5 } }] },
    { id: "R09", title: "‡∏ã‡∏≠‡∏ü‡∏ï‡πå‡πÅ‡∏ß‡∏£‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ License", description: "‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå", choices: [{ text: "‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö (‡πÄ‡∏™‡∏µ‡∏¢ $25K)", effect: { money: -25000 } }, { text: "‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° (‡πÄ‡∏™‡∏µ‡∏¢ 10 Ops)", effect: { operations: -10 } }] },
    { id: "R10", title: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•", description: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•", choices: [{ text: "‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏™‡∏µ‡∏¢ 10 Rep, $10K)", effect: { reputation: -10, money: -10000 } }, { text: "‡∏õ‡∏¥‡∏î‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏á‡∏µ‡∏¢‡∏ö (‡πÄ‡∏™‡∏µ‡∏¢ 2üõ°Ô∏è)", effect: { shields: -2 } }] },
    { id: "R11", title: "‡∏£‡∏∞‡∏ö‡∏ö Backup ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", description: "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå", choices: [{ text: "‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÄ‡∏™‡∏µ‡∏¢ $15K)", effect: { money: -15000 } }, { text: "‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏™‡∏µ‡∏¢ 1üõ°Ô∏è)", effect: { shields: -1 } }] },
    { id: "R12", title: "CEO ‡∏ó‡∏≥‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏´‡∏≤‡∏¢", description: "‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ CEO ‡∏´‡∏≤‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó", choices: [{ text: "‡∏™‡∏±‡πà‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏™‡∏µ‡∏¢ 10 Ops)", effect: { operations: -10 } }, { text: "‡∏´‡∏ß‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡πÄ‡∏™‡∏µ‡∏¢ 15 Rep)", effect: { reputation: -15 } }] },
    { id: "R13", title: "Social Engineering", description: "‡∏°‡∏µ‡∏Ñ‡∏ô‡πÇ‡∏ó‡∏£‡∏°‡∏≤‡∏´‡∏•‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô IT ‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", choices: [{ text: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡πÄ‡∏™‡∏µ‡∏¢ 5 Ops)", effect: { operations: -5 } }, { text: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠ (‡πÄ‡∏™‡∏µ‡∏¢ 3üõ°Ô∏è)", effect: { shields: -3 } }] },
    { id: "R14", title: "‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà Zero-Day", description: "‡∏û‡∏ö‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡πÉ‡∏ô‡∏ã‡∏≠‡∏ü‡∏ï‡πå‡πÅ‡∏ß‡∏£‡πå", choices: [{ text: "‡∏ó‡∏µ‡∏° IT ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏∑‡∏ô (‡πÄ‡∏™‡∏µ‡∏¢ 5 Ops)", effect: { operations: -5 } }, { text: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Patch (‡πÄ‡∏™‡∏µ‡∏¢ 2üõ°Ô∏è)", effect: { shields: -2 } }] },
    { id: "R15", title: "‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡∏∑‡∏≠‡πÅ‡∏á‡πà‡∏•‡∏ö", description: "‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÇ‡∏î‡∏ô‡πÅ‡∏Æ‡∏Å", choices: [{ text: "‡∏ó‡∏µ‡∏° PR ‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á (‡πÄ‡∏™‡∏µ‡∏¢ $5K)", effect: { money: -5000 } }, { text: "‡πÑ‡∏°‡πà‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á (‡πÄ‡∏™‡∏µ‡∏¢ 10 Rep)", effect: { reputation: -10 } }] }
];
const quizCards = [
    { id: "Q01", question: "‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏• Phishing ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?", choices: ["‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π", "Hover ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π URL ‡∏à‡∏£‡∏¥‡∏á", "‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡∏≤‡∏°"], answer: 1 },
    { id: "Q02", question: "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡πÉ‡∏î‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?", choices: ["'Summer2025'", "'TreeCarBlueWindow'", "'CatName1990'"], answer: 1 },
    { id: "Q03", question: "'Ransomware' ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?", choices: ["‡∏°‡∏±‡∏•‡πÅ‡∏ß‡∏£‡πå‡∏Ç‡πÇ‡∏°‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï", "‡∏°‡∏±‡∏•‡πÅ‡∏ß‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡πà‡∏≤‡πÑ‡∏ñ‡πà", "‡∏°‡∏±‡∏•‡πÅ‡∏ß‡∏£‡πå‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡πâ‡∏≤"], answer: 1 },
    { id: "Q04", question: "‡πÄ‡∏à‡∏≠ USB Drive ‡∏ï‡∏Å‡∏≠‡∏¢‡∏π‡πà ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?", choices: ["‡πÄ‡∏™‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏≠‡∏°‡∏î‡∏π‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÉ‡∏Ñ‡∏£", "‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ", "‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ù‡πà‡∏≤‡∏¢ IT ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏ö"], answer: 2 },
    { id: "Q05", question: "Two-Factor Authentication (2FA) ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?", choices: ["‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô 2 ‡∏ä‡∏∏‡∏î", "‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô + ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ (‡πÄ‡∏ä‡πà‡∏ô OTP)", "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å 2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"], answer: 1 },
    { id: "Q06", question: "‡∏Ç‡πâ‡∏≠‡πÉ‡∏î‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á 'Juice Jacking'?", choices: ["‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏Ç‡πÇ‡∏°‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≤‡∏¢‡∏ä‡∏≤‡∏£‡πå‡∏à USB ‡∏õ‡∏•‡∏≠‡∏°", "‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏î‡∏π‡∏î‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏à‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏£‡πá‡∏ß", "‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ï‡∏±‡∏ß"], answer: 0 },
    { id: "Q07", question: "‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ã‡∏≠‡∏ü‡∏ï‡πå‡πÅ‡∏ß‡∏£‡πå‡πÄ‡∏™‡∏°‡∏≠?", choices: ["‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà", "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢", "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô"], answer: 1 },
    { id: "Q08", question: "'Social Engineering' ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?", choices: ["‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÅ‡∏Æ‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á", "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏´‡∏•‡∏≠‡∏Å‡∏•‡πà‡∏≠‡∏Ñ‡∏ô", "‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏õ‡∏•‡∏≠‡∏°"], answer: 1 },
    { id: "Q09", question: "‡∏Ç‡πâ‡∏≠‡πÉ‡∏î '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà' ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ï‡∏≤‡∏° PDPA?", choices: ["‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠", "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó", "‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠"], answer: 1 },
    { id: "Q10", question: "‡∏ó‡∏≥‡πÑ‡∏°‡∏Å‡∏≤‡∏£ Backup ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∂‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç?", choices: ["‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°", "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢", "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå"], answer: 1 },
    { id: "Q11", question: "'Vishing' ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏î?", choices: ["‡πÉ‡∏ä‡πâ‡πÑ‡∏ß‡∏£‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô USB", "‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏´‡∏•‡∏≠‡∏Å‡∏•‡∏ß‡∏á", "‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏õ‡∏•‡∏≠‡∏°"], answer: 1 },
    { id: "Q12", question: "‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£ 'Least Privilege' ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡∏≠‡∏∞‡πÑ‡∏£?", choices: ["‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô", "‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á", "‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å"], answer: 0 },
    { id: "Q13", question: "‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠?", choices: ["‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ä‡∏ó‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß", "‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏ü‡∏•‡πå", "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏™‡πà‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ß‡∏≤‡∏á‡∏ö‡∏ô‡πÇ‡∏ï‡πä‡∏∞"], answer: 1 },
    { id: "Q14", question: "'DDoS' ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡πÅ‡∏ö‡∏ö‡πÉ‡∏î?", choices: ["‡∏™‡πà‡∏á‡πÑ‡∏ß‡∏£‡∏±‡∏™‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "‡πÄ‡∏î‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•", "‡∏£‡∏∞‡∏î‡∏°‡∏¢‡∏¥‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡∏•‡πà‡∏°"], answer: 2 },
    { id: "Q15", question: "'Firewall' ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏≠‡∏∞‡πÑ‡∏£?", choices: ["‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏à‡∏£‡∏≤‡∏à‡∏£", "‡∏¢‡∏≤‡∏°‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢", "‡∏ö‡∏∏‡∏£‡∏∏‡∏©‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå"], answer: 1 }
];

let players = [];
let currentPlayerIndex = 0;
let gameStarted = false;
let gameRound = 0;
const MAX_ROUNDS = 25;

let shuffledGreenCards, shuffledRedCards, shuffledQuizCards, bankruptPlayers = [];

const playerColors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f'];
const playerIcons = [
    `<svg viewBox="0 0 24 24"><path fill="{color}" d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>`,
    `<svg viewBox="0 0 24 24"><path fill="{color}" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`,
    `<svg viewBox="0 0 24 24"><path fill="{color}" d="M20,19V5c0-1.1-0.9-2-2-2H6C4.9,3,4,3.9,4,5v14H3v2h18v-2H20z M14,17H8v-2h6V17z M18,13H6V5h12V13z"/></svg>`,
    `<svg viewBox="0 0 24 24"><path fill="{color}" d="M20.57 14.86L22 13.43 20.57 12 17 15.57 13.43 12 12 13.43 15.57 17 12 20.57 13.43 22 17 18.43 20.57 22 22 20.57 18.43 17l2.14-2.14M17.14 6.86L18 6l-2-2-1.14 1.14L13.72 4.01l-1.41 1.41l1.13 1.13l-1.41 1.41l-1.13-1.13L9.48 8.28l1.41 1.41l1.13-1.13l1.41 1.41l-1.13 1.13l1.41 1.41l1.13-1.13l1.42 1.42l-1.14 1.14L18 12l2-2-1.14-1.14-1.41-1.41l1.69-1.59zM3.43 12L12 3.43 20.57 12 12 20.57 3.43 12z"/></svg>`
];


const {
    logBox, playerCountSelect, startGameBtn, setupModal, playersInfoContainer, board, 
    rollDiceBtn, manualRollBtn, diceInput, diceResult, endTurnBtn, currentPlayerName,
    purchaseModal, cardModal, eventRollModal, alertModal, roundCounter,
    saveGameBtn, resetGameBtn,
    actionSummaryModal
} = {
    logBox: document.getElementById('log-box'),
    playerCountSelect: document.getElementById('player-count'),
    startGameBtn: document.getElementById('start-game-btn'),
    setupModal: document.getElementById('setup-modal'),
    playersInfoContainer: document.getElementById('players-info-container'),
    board: document.getElementById('board'),
    rollDiceBtn: document.getElementById('roll-dice-btn'),
    manualRollBtn: document.getElementById('manual-roll-btn'),
    diceInput: document.getElementById('dice-input'),
    diceResult: document.getElementById('dice-result'),
    endTurnBtn: document.getElementById('end-turn-btn'),
    currentPlayerName: document.getElementById('current-player-name'),
    purchaseModal: document.getElementById('purchase-modal'),
    cardModal: document.getElementById('card-modal'),
    eventRollModal: document.getElementById('event-roll-modal'),
    alertModal: document.getElementById('alert-modal'),
    roundCounter: document.getElementById('round-counter'),
    saveGameBtn: document.getElementById('save-game-btn'),
    resetGameBtn: document.getElementById('reset-game-btn'),
    actionSummaryModal: document.getElementById('action-summary-modal')
};

function addLog(message, showPopup = false, popupTitle = '‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå') {
    logBox.innerHTML += `<p>${message}</p>`;
    logBox.scrollTop = logBox.scrollHeight;
    if (showPopup) {
        showActionSummary(popupTitle, message);
    }
}

function showActionSummary(title, message) {
    const content = `<div class="action-summary-content">
                        <div class="action-summary-title">${title}</div>
                        <div class="action-summary-message">${message}</div>
                     </div>`;
    actionSummaryModal.innerHTML = content;
    actionSummaryModal.style.display = 'flex';
    setTimeout(() => {
        actionSummaryModal.innerHTML = '';
        actionSummaryModal.style.display = 'none';
    }, 3000); // Popup disappears after 3 seconds
}

function populateBoard() {
    spaceData.forEach(spaceInfo => {
        const spaceEl = document.querySelector(`[data-id='${spaceInfo.id}']`);
        if (spaceEl) {
            let typeText = '';
            if (spaceInfo.type === 'investment') typeText = '‡∏•‡∏á‡∏ó‡∏∏‡∏ô';
            else if (spaceInfo.type === 'event') typeText = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå';
            else if (spaceInfo.type === 'knowledge') typeText = '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ';
            else if (spaceInfo.type.includes('corner')) typeText = '‡∏°‡∏∏‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©';
            spaceEl.innerHTML = `<div class="space-name">${spaceInfo.name}</div><div class="space-type">${typeText}</div><div class="space-cost">${spaceInfo.costText}</div>`;
        }
    });
}

function updateUI() {
    playersInfoContainer.innerHTML = '';
    players.forEach((p, index) => {
        const playerDiv = document.createElement('div');
        playerDiv.className = 'player-info';
        if (index === currentPlayerIndex) {
            playerDiv.classList.add('active');
            playerDiv.style.borderColor = playerColors[index];
        }

        const BASELINE_MONEY = 80000;
        const BASELINE_SHIELDS = 5;
        const BASELINE_REP = 100;
        const BASELINE_OPS = 100;
        const MONEY_WEIGHT = 25;
        const SHIELD_WEIGHT = 35;
        const REP_WEIGHT = 20;
        const OPS_WEIGHT = 20;

        const moneyScore = (p.money / BASELINE_MONEY) * MONEY_WEIGHT;
        const shieldScore = (p.shields / BASELINE_SHIELDS) * SHIELD_WEIGHT;
        const repScore = (p.reputation / BASELINE_REP) * REP_WEIGHT;
        const opsScore = (p.operations / BASELINE_OPS) * OPS_WEIGHT;

        p.score = Math.round(moneyScore + shieldScore + repScore + opsScore);

        const scoreBreakdown = `Contribution to Score:
` +
                               `Money: ${moneyScore.toFixed(1)}
` +
                               `Shields: ${shieldScore.toFixed(1)}
` +
                               `Reputation: ${repScore.toFixed(1)}
` +
                               `Operations: ${opsScore.toFixed(1)}`;

        playerDiv.innerHTML = `
            <div class="player-name" style="color: ${playerColors[index]}">${p.name}</div>
            <div class="player-stats">
                <span>üí∞${p.money.toLocaleString()}</span>
                <span>üõ°Ô∏è${p.shields}</span>
                <span>üìä${p.reputation}</span>
                <span>‚öôÔ∏è${p.operations}%</span>
            </div>
            <div class="player-score" title="${scoreBreakdown}">Cyber Score: ${p.score} ‚ÑπÔ∏è</div>
        `;
        playersInfoContainer.appendChild(playerDiv);
    });

    players.forEach((p, index) => {
        const piece = document.getElementById(`p${index+1}-piece`);
        const space = document.querySelector(`[data-id='${p.position}']`);
        if (piece && space) space.appendChild(piece);
    });
    
    document.querySelectorAll('.owner-marker').forEach(marker => marker.remove());
    spaceData.forEach(space => {
        const spaceEl = document.querySelector(`[data-id='${space.id}']`);
        if (space.owner !== null && space.owner !== undefined) {
            spaceEl.style.borderColor = playerColors[space.owner];
            spaceEl.style.borderWidth = '3px';
            const ownerMarker = document.createElement('div');
            ownerMarker.className = 'owner-marker';
            ownerMarker.style.backgroundColor = playerColors[space.owner];
            spaceEl.appendChild(ownerMarker);
        } else if (spaceEl) {
            spaceEl.style.borderColor = '#34495e';
            spaceEl.style.borderWidth = '1px';
        }
    });

    if(players.length > 0) {
        const player = players[currentPlayerIndex];
        currentPlayerName.textContent = player.name;
        currentPlayerName.style.color = playerColors[currentPlayerIndex];
        const isTurnActionFinished = player.hasRolled;
        rollDiceBtn.disabled = !gameStarted || isTurnActionFinished;
        manualRollBtn.disabled = !gameStarted || isTurnActionFinished;
        diceInput.disabled = !gameStarted || isTurnActionFinished;
        endTurnBtn.disabled = !gameStarted || !isTurnActionFinished;
    }
    roundCounter.textContent = `‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà: ${gameRound} / ${MAX_ROUNDS}`;
}

function setupGame() {
    addLog("--- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà ---");
    populateBoard();
    setupDecks();
    
    players = [];
    gameRound = 1;
    spaceData.forEach(s => s.owner = null); // Reset owners
    document.querySelectorAll('.player-piece').forEach(p => p.remove());

    const numPlayers = parseInt(playerCountSelect.value);
    for (let i = 0; i < numPlayers; i++) {
        players.push({ name: `Player ${i+1}`, position: 1, money: 80000, shields: 5, reputation: 100, operations: 100, inQuarantine: 0, hasRolled: false, score: 100 });
        const piece = document.createElement('div');
        piece.className = 'player-piece';
        piece.id = `p${i+1}-piece`;
        piece.innerHTML = playerIcons[i].replace('{color}', playerColors[i]);
        const offsetsX = ['10%', '60%', '10%', '60%'];
        const offsetsY = ['10%', '10%', '60%', '60%'];
        piece.style.left = offsetsX[i];
        piece.style.top = offsetsY[i];
        document.querySelector(`[data-id='1']`).appendChild(piece);
    }
    
    gameStarted = true;
    setupModal.style.display = 'none';
    addLog(`‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏±‡∏ö ${numPlayers} ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô.`);
    addLog(`--- ‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á Player 1 (‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1) ---`);
    updateUI();
}

function endTurn() {
    if (players.length === 0 || !players[currentPlayerIndex].hasRolled) { addLog("‡∏ó‡∏≠‡∏¢‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏ö‡∏ï‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
    if (checkForWinner()) return;

    players[currentPlayerIndex].hasRolled = false;
    
    if (currentPlayerIndex === players.length - 1) {
        gameRound++;
        addLog(`--- ‡∏à‡∏ö‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${gameRound-1} ---`);
        if (checkForWinner()) return;
    }

    currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
    
    const player = players[currentPlayerIndex];
    if (player.inQuarantine > 0) {
        addLog(`${player.name} ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Quarantine ‡∏à‡∏∂‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏ï‡∏≤‡∏ô‡∏µ‡πâ`);
        player.inQuarantine--;
        setTimeout(() => { players[currentPlayerIndex].hasRolled = true; updateUI(); endTurn(); }, 1500);
        updateUI();
        return;
    }

    addLog(`--- ‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á ${player.name} (‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${gameRound}) ---`);
    updateUI();
}

function movePlayer(roll) {
    if (players[currentPlayerIndex].hasRolled) return;
    let player = players[currentPlayerIndex];
    player.hasRolled = true;
    addLog(`${player.name} ‡∏ó‡∏≠‡∏¢‡πÑ‡∏î‡πâ ${roll}.`);
    
    const oldPosition = player.position;
    let newPosition = player.position + roll;
    if (newPosition > 40) {
        newPosition -= 40;
        player.money += 15000;
        player.shields += 1;
        const passGoMessage = `${player.name} ‡πÄ‡∏î‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö $15,000 ‡πÅ‡∏•‡∏∞ 1 üõ°Ô∏è.`;
        addLog(passGoMessage, true, "‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà!");
    }
    player.position = newPosition;
    
    addLog(`${player.name} ‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á ${spaceData.find(s => s.id === newPosition).name}.`);
    updateUI();
    setTimeout(() => handleSpaceAction(player.position), 500);
}

function handleSpaceAction(position) {
    const space = spaceData.find(s => s.id === position);
    const player = players[currentPlayerIndex];

    switch(space.type) {
        case 'investment':
            if (space.owner === null) promptPurchase(space);
            else if (space.owner !== currentPlayerIndex) payRent(space);
            else addLog(`${player.name} ‡∏ï‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á`);
            break;
        case 'event': promptEventRoll(); break;
        case 'knowledge': drawCard('quiz', space.reward); break;
        case 'corner-alert': promptSystemAlert(); break;
        case 'corner-quarantine':
            if (space.id === 30) { // Go to Quarantine
                addLog(`${player.name} ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà Quarantine!`);
                player.position = 40;
                player.inQuarantine = 1;
                updateUI();
            } else if (space.id === 40) { // Landed on Quarantine
                addLog(`${player.name} ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Quarantine ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î 1 ‡∏ï‡∏≤`);
                player.inQuarantine = 1;
            }
            break;
    }
    updateUI();
}

function payRent(space) {
    const payer = players[currentPlayerIndex];
    const owner = players[space.owner];
    const rent = space.rent;
    const rentMessage = `${payer.name} ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö ${rent.toLocaleString()} ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö ${owner.name}.`;
    addLog(rentMessage, true, "‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö");
    if (payer.money < rent) {
        addLog(`${payer.name} ‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö!`);
        handleBankruptcy(currentPlayerIndex);
    } else {
        payer.money -= rent;
        owner.money += rent;
        addLog(`${payer.name} ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        updateUI();
    }
}

function handleBankruptcy(playerIndex) {
    const bankruptPlayer = players[playerIndex];
    const bankruptcyMessage = `--- ${bankruptPlayer.name} ‡∏•‡πâ‡∏°‡∏•‡∏∞‡∏•‡∏≤‡∏¢! ---`;
    addLog(bankruptcyMessage, true, "‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏•‡πâ‡∏°‡∏•‡∏∞‡∏•‡∏≤‡∏¢");
    bankruptPlayers.push(bankruptPlayer); // Track bankrupt player
    spaceData.forEach(space => { if (space.owner === playerIndex) space.owner = null; });
    document.getElementById(`p${playerIndex + 1}-piece`).remove();
    players.splice(playerIndex, 1);
    if (currentPlayerIndex >= playerIndex && players.length > 0) {
        currentPlayerIndex = (players.length + currentPlayerIndex - 1) % players.length;
    }
    if (!checkForWinner()) updateUI();
}

function checkForWinner() {
    if (players.length <= 1) {
        endGame(players[0]);
        return true;
    }
    if (gameRound > MAX_ROUNDS) {
        addLog(`‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ñ‡∏£‡∏ö ${MAX_ROUNDS} ‡∏£‡∏≠‡∏ö`);
        const winner = players.reduce((best, p) => p.score > best.score ? p : best, players[0]);
        endGame(winner, true);
        return true;
    }
    return false;
}

function endGame(winner, byRounds = false) {
    gameStarted = false;
    localStorage.removeItem('cyberMonopolySave'); // Clear save on game end

    let allPlayers = [...players, ...bankruptPlayers].sort((a, b) => b.score - a.score);

    let message = byRounds ? 
        `‡∏Ñ‡∏£‡∏ö ${MAX_ROUNDS} ‡∏£‡∏≠‡∏ö! ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡∏Ñ‡∏∑‡∏≠ ${winner.name} ‡∏ó‡∏µ‡πà‡∏°‡∏µ Cyber Score ‡∏™‡∏π‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!` : 
        `‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏≠‡∏î‡∏Ñ‡∏∑‡∏≠ ${winner.name}!`;

    let scoreboardHTML = allPlayers.map(p => {
        const isWinner = p.name === winner.name;
        const status = bankruptPlayers.some(bp => bp.name === p.name) ? ' (‡∏•‡πâ‡∏°‡∏•‡∏∞‡∏•‡∏≤‡∏¢)' : '';
        return `<div style="padding: 5px; ${isWinner ? 'background-color: #d4edda;' : ''}">
                    <strong>${isWinner ? 'üèÜ' : ''} ${p.name}${status}:</strong> 
                    Cyber Score: ${p.score}
                </div>`;
    }).join('');

    const html = `<h2>‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</h2>
        <p>${message}</p>
        <h3 style="margin-top: 20px; margin-bottom: 10px; text-align: left;">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</h3>
        <div style="text-align: left; margin-bottom: 20px;">${scoreboardHTML}</div>
        <button class="btn" onclick="location.reload()">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>`;

    showModal(alertModal, html);
    addLog(`--- ${message} ---`);
}

function showModal(modalElement, contentHTML) { modalElement.innerHTML = `<div class="modal-content">${contentHTML}</div>`; modalElement.style.display = 'flex'; }
function closeModal(modalElement) { modalElement.style.display = 'none'; }

function promptPurchase(space) {
    const player = players[currentPlayerIndex];
    const canAfford = player.money >= space.cost;
    const html = `<h2>‡∏ã‡∏∑‡πâ‡∏≠ ${space.name}?</h2><p>‡∏£‡∏≤‡∏Ñ‡∏≤: $${space.cost.toLocaleString()}</p><p>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: +${space.reward} üõ°Ô∏è</p>
        <div style="margin-top: 20px;"><button id="buy-btn" class="btn" ${canAfford ? '' : 'disabled'}>‡∏ã‡∏∑‡πâ‡∏≠</button>
        <button id="pass-btn" class="btn" style="background: #c0392b;">‡πÑ‡∏°‡πà‡∏ã‡∏∑‡πâ‡∏≠</button></div>
        ${!canAfford ? '<p style="color: red; margin-top: 10px;">‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠</p>' : ''}`;
    showModal(purchaseModal, html);
    document.getElementById('buy-btn').onclick = () => { player.money -= space.cost; player.shields += space.reward; space.owner = currentPlayerIndex; addLog(`${player.name} ‡∏ã‡∏∑‡πâ‡∏≠ ${space.name} ‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${space.reward} üõ°Ô∏è.`); closeModal(purchaseModal); updateUI(); };
    document.getElementById('pass-btn').onclick = () => { addLog(`${player.name} ‡πÑ‡∏°‡πà‡∏ã‡∏∑‡πâ‡∏≠ ${space.name}.`); closeModal(purchaseModal); };
}

function promptSystemAlert() {
    const player = players[currentPlayerIndex];
    const html = `<h2>System Alert!</h2><p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á:</p>
        <div style="margin-top: 20px; display: flex; justify-content: center; gap: 15px;">
        <button id="pay-fine-btn" class="btn">‡∏à‡πà‡∏≤‡∏¢ $5,000</button>
        <button id="lose-ops-btn" class="btn" style="background: #f39c12;">‡πÄ‡∏™‡∏µ‡∏¢ 5% Operations</button></div>`;
    showModal(alertModal, html);
    document.getElementById('pay-fine-btn').onclick = () => { if (player.money < 5000) { addLog("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö!"); handleBankruptcy(currentPlayerIndex); } else { player.money -= 5000; addLog(`${player.name} ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö $5,000.`); updateUI(); } closeModal(alertModal); };
    document.getElementById('lose-ops-btn').onclick = () => { player.operations -= 5; addLog(`${player.name} ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏™‡∏µ‡∏¢ 5% Operations.`); closeModal(alertModal); updateUI(); };
}

function promptEventRoll() {
    const html = `<h2>‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏ù‡∏±‡∏ô!</h2><p>‡∏ó‡∏≠‡∏¢‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤ 1 ‡∏•‡∏π‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤ (‡∏™‡∏π‡∏á=‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß, ‡∏ï‡πà‡∏≥=‡πÅ‡∏î‡∏á)</p>
        <div class="dice-area" style="justify-content: center; margin-top: 15px;">
            <button id="event-dice-roll-btn" class="btn">‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏ï‡πã‡∏≤</button>
            <input type="number" id="event-dice-input" min="1" max="6" placeholder="‡πÄ‡∏•‡∏Ç">
            <button id="event-manual-roll-btn" class="btn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
        <p style="font-size: 3rem; margin: 15px 0;" id="event-dice-result">üé≤</p>`;
    showModal(eventRollModal, html);

    const handleEventRoll = (roll) => {
        document.getElementById('event-dice-result').innerText = roll;
        document.getElementById('event-dice-roll-btn').disabled = true;
        document.getElementById('event-manual-roll-btn').disabled = true;
        document.getElementById('event-dice-input').disabled = true;

        setTimeout(() => {
            closeModal(eventRollModal);
            if (roll >= 4) {
                addLog(`‡∏ó‡∏≠‡∏¢‡πÑ‡∏î‡πâ ${roll} (‡πÄ‡∏•‡∏Ç‡∏™‡∏π‡∏á)! ‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß`);
                drawCard('green');
            } else {
                addLog(`‡∏ó‡∏≠‡∏¢‡πÑ‡∏î‡πâ ${roll} (‡πÄ‡∏•‡∏Ç‡∏ï‡πà‡∏≥)... ‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏î‡∏á`);
                drawCard('red');
            }
        }, 1500);
    };

    document.getElementById('event-dice-roll-btn').onclick = () => {
        const roll = rollSingleDie();
        handleEventRoll(roll);
    };
    
    document.getElementById('event-manual-roll-btn').onclick = () => {
        const roll = parseInt(document.getElementById('event-dice-input').value);
        if (roll >= 1 && roll <= 6) {
            handleEventRoll(roll);
        } else {
            addLog('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 1 ‡∏ñ‡∏∂‡∏á 6 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
        }
    };
}

function shuffle(array) {
    let currentIndex = array.length,  randomIndex;
    while (currentIndex != 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
}

function setupDecks() {
    shuffledGreenCards = shuffle([...greenCards]);
    shuffledRedCards = shuffle([...redCards]);
    shuffledQuizCards = shuffle([...quizCards]);
    addLog("--- ‡∏™‡∏≥‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ñ‡∏π‡∏Å‡∏™‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà ---");
}

function drawCard(type, reward = null) {
    let card, cardPool, deckName;
    if (type === 'green') {
        if (!shuffledGreenCards || shuffledGreenCards.length === 0) setupDecks();
        cardPool = shuffledGreenCards;
        deckName = "‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß";
    } else if (type === 'red') {
        if (!shuffledRedCards || shuffledRedCards.length === 0) setupDecks();
        cardPool = shuffledRedCards;
        deckName = "‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏î‡∏á";
    } else if (type === 'quiz') {
        if (!shuffledQuizCards || shuffledQuizCards.length === 0) setupDecks();
        cardPool = shuffledQuizCards;
        deckName = "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ";
    }

    if (!cardPool || cardPool.length === 0) {
        addLog(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡πà‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏î‡πâ (${deckName}) ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏£‡∏±‡∏ö`);
        return;
    }

    card = cardPool.pop(); // Draw the top card
    addLog(`${players[currentPlayerIndex].name} ‡∏à‡∏±‡πà‡∏ß ${deckName}. ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${cardPool.length} ‡πÉ‡∏ö‡πÉ‡∏ô‡∏™‡∏≥‡∏£‡∏±‡∏ö`);

    let cardHTML = `<div class="card-back">`;
    if (type === 'quiz') {
        card.reward = reward;
        cardHTML += `<div class="card-title">${card.question}</div><div class="card-choices quiz-choices">
            ${card.choices.map((choice, index) => `<div class="choice" onclick="handleQuizAnswer(${index}, ${card.answer}, '${card.id}')">${String.fromCharCode(65+index)}) ${choice}</div>`).join('')}</div>`;
    } else {
        cardHTML += `<div class="card-title">${card.title}</div><div class="card-description">${card.description}</div>`;
        if (card.effect) {
            cardHTML += `<div class="card-result">‡∏ú‡∏•: ${getEffectText(card.effect)}</div><button class="btn" onclick="applyCardEffect('${card.id}', '${type}')">OK</button>`;
        }
        if (card.choices) {
            cardHTML += `<div class="card-choices">${card.choices.map((choice, index) => `<div class="choice" onclick="applyCardEffect('${card.id}', '${type}', ${index})">${choice.text}</div>`).join('')}</div>`;
            if (type === 'red') cardHTML += `<button class="btn shield-btn" onclick="useShieldToCancel('${card.id}')">‡πÉ‡∏ä‡πâ 1üõ°Ô∏è ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>`;
        }
    }
    cardHTML += `</div>`;
    const modalContent = `<div class="modal-content ${type}-card">${cardHTML}</div>`;
    cardModal.innerHTML = modalContent;
    cardModal.style.display = 'flex';
}

function getEffectText(effect) {
    return Object.entries(effect).map(([key, value]) => {
        let text = value >= 0 ? '+' : '';
        if (key === 'money') text += `$${Math.abs(value).toLocaleString()}`;
        else if (key === 'shields') text += `${value}üõ°Ô∏è`;
        else if (key === 'reputation') text += `${value} Rep`;
        else if (key === 'operations') text += `${value}% Ops`;
        return text;
    }).join(', ');
}

function useShieldToCancel(cardId) {
    const player = players[currentPlayerIndex];
    if (player.shields > 0) {
        player.shields--;
        addLog(`${player.name} ‡πÉ‡∏ä‡πâ 1 üõ°Ô∏è ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î '${redCards.find(c=>c.id === cardId).title}'.`);
        closeModal(cardModal);
        updateUI();
    } else {
        addLog(`${player.name} ‡πÑ‡∏°‡πà‡∏°‡∏µ üõ°Ô∏è ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ!`);
        const shieldBtn = document.querySelector('.shield-btn');
        if(shieldBtn) shieldBtn.disabled = true;
    }
}

function applyCardEffect(cardId, type, choiceIndex = -1) {
    const player = players[currentPlayerIndex];
    let card, effect, logText;
    if (type === 'green') card = greenCards.find(c => c.id === cardId);
    else if (type === 'red') card = redCards.find(c => c.id === cardId);

    if (choiceIndex !== -1) { const choice = card.choices[choiceIndex]; effect = choice.effect; logText = `${player.name} ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${choice.text}`; }
    else { effect = card.effect; logText = `${player.name} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏à‡∏≤‡∏Å: ${card.title}.`; }
    addLog(logText);

    if (effect) {
        if(effect.money && player.money + effect.money < 0) { handleBankruptcy(currentPlayerIndex); } else {
            if(effect.money) player.money += effect.money;
            if(effect.shields) player.shields += effect.shields;
            if(effect.reputation) player.reputation += effect.reputation;
            if(effect.operations) player.operations += effect.operations;
        }
    }
    updateUI();
    closeModal(cardModal);
}

function handleQuizAnswer(selectedIndex, correctIndex, cardId) {
    const player = players[currentPlayerIndex];
    const space = spaceData.find(s => s.id === player.position);
    if (selectedIndex === correctIndex) {
        const reward = space.reward;
        addLog(`‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ${player.name} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${getEffectText(reward)}`);
        if(reward.shields) player.shields += reward.shields;
        if(reward.money) player.money += reward.money;
    } else {
        addLog(`‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô`);
    }
    updateUI();
    closeModal(cardModal);
}

// --- UTILITY & GAME STATE FUNCTIONS ---
function secureRandomIndex(arrayLength) {
    const randomArray = new Uint32Array(1);
    window.crypto.getRandomValues(randomArray);
    return randomArray[0] % arrayLength;
}

function rollSingleDie() {
    const randomArray = new Uint8Array(1);
    window.crypto.getRandomValues(randomArray);
    return (randomArray[0] % 6) + 1;
}

function saveGameState() {
    if (!gameStarted) {
        addLog("‡πÄ‡∏Å‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏° ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ");
        return;
    }
    const state = {
        players: players,
        currentPlayerIndex: currentPlayerIndex,
        gameRound: gameRound,
        gameStarted: gameStarted,
        spaceOwners: spaceData.map(s => s.owner),
        shuffledGreenCards: shuffledGreenCards,
        shuffledRedCards: shuffledRedCards,
        shuffledQuizCards: shuffledQuizCards
    };
    localStorage.setItem('cyberMonopolySave', JSON.stringify(state));
    addLog("--- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ---");
}

function loadGameState() {
    const savedState = localStorage.getItem('cyberMonopolySave');
    if (savedState) {
        const state = JSON.parse(savedState);
        players = state.players;
        currentPlayerIndex = state.currentPlayerIndex;
        gameRound = state.gameRound;
        gameStarted = state.gameStarted;
        shuffledGreenCards = state.shuffledGreenCards || [];
        shuffledRedCards = state.shuffledRedCards || [];
        shuffledQuizCards = state.shuffledQuizCards || [];

        state.spaceOwners.forEach((owner, i) => {
            spaceData[i].owner = owner;
        });

        addLog("--- ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ ---");
        populateBoard();
        document.querySelectorAll('.player-piece').forEach(p => p.remove());
        players.forEach((p, i) => {
            const piece = document.createElement('div');
            piece.className = 'player-piece';
            piece.id = `p${i+1}-piece`;
            piece.innerHTML = playerIcons[i].replace('{color}', playerColors[i]);
            document.body.appendChild(piece); // Add to body temporarily
        });
        
        setupModal.style.display = 'none';
        updateUI();
        return true;
    }
    return false;
}

function resetGame() {
    if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö")) {
        localStorage.removeItem('cyberMonopolySave');
        location.reload();
    }
}

// --- EVENT LISTENERS & GAME START ---
window.addEventListener('load', () => {
    if (!loadGameState()) {
        setupModal.style.display = 'flex';
    }
});

startGameBtn.addEventListener('click', setupGame);
rollDiceBtn.addEventListener('click', () => { 
    const roll = rollSingleDie() + rollSingleDie(); 
    diceResult.textContent = `üé≤ ${roll}`; 
    diceResult.classList.add('dice-flash');
    setTimeout(() => diceResult.classList.remove('dice-flash'), 400);
    movePlayer(roll); 
});
manualRollBtn.addEventListener('click', () => { 
    const roll = parseInt(diceInput.value); 
    if (roll >= 2 && roll <= 12) { 
        diceResult.textContent = `üé≤ ${roll}`; 
        diceResult.classList.add('dice-flash');
        setTimeout(() => diceResult.classList.remove('dice-flash'), 400);
        movePlayer(roll); 
        diceInput.value = ''; 
    } else { 
        addLog('‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 2 ‡∏ñ‡∏∂‡∏á 12 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'); 
    } 
});
endTurnBtn.addEventListener('click', endTurn);
saveGameBtn.addEventListener('click', saveGameState);
resetGameBtn.addEventListener('click', resetGame);

</script>
</body>
</html>
